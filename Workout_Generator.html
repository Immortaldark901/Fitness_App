<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Workout Generator - NutriHealth</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Navbar placeholder -->
  <div id="navbar-placeholder"></div>

  <main class="workout-container" role="main">
    <header>
      <h1>Workout Generator</h1>
      <p class="lead">Choose workout types, pick exercises and build a reusable plan.</p>
    </header>

    <section class="controls">
      <label for="workoutType">Workout Type</label>
      <select id="workoutType" aria-label="Select workout type">
        <option value="">-- Select Workout Type --</option>
        <option value="strength">Strength</option>
        <option value="cardio">Cardio</option>
        <option value="core">Core</option>
        <option value="legs">Legs</option>
        <option value="arms">Arms</option>
        <option value="flexibility">Flexibility</option>
        <option value="fullbody">Full Body</option>
      </select>

      <button id="showBtn" class="primary">Show Workouts</button>
      <button id="clearSaved" class="outline">Clear Saved Plan</button>
    </section>

    <section id="workout-list" class="workout-list" aria-live="polite">
      <!-- generated workout cards appear here -->
    </section>

    <section class="plan-section">
      <h2>My Workout Plan</h2>

      <div id="user-plan" class="user-plan" aria-live="polite">
        <p class="muted">No workouts added yet.</p>
      </div>

      <div class="plan-actions">
        <button id="savePlan" class="primary">Save Plan</button>
        <button id="exportPlan" class="outline">Export Plan</button>
      </div>

      <pre id="exportArea" class="export-area" hidden></pre>
    </section>
  </main>

  <!-- Navbar Loader -->
  <script src="script.js"></script>

  <!-- Workout Generator Logic -->
  <script type="module">
    import { supabase } from './supabaseClient.js';

    const workoutData = {
      strength: ["Push-ups","Pull-ups","Squats","Bench Press","Deadlifts","Overhead Press","Bicep Curls","Tricep Dips"],
      cardio: ["Running","Cycling","Jump Rope","Burpees","Mountain Climbers","High Knees","Treadmill Sprint","Stair Climb"],
      core: ["Plank","Russian Twists","Crunches","Leg Raises","Bicycle Crunches","Side Plank","Hanging Knee Raises","Flutter Kicks"],
      legs: ["Lunges","Squats","Leg Press","Step Ups","Calf Raises","Wall Sit","Glute Bridge","Bulgarian Split Squat"],
      arms: ["Bicep Curls","Tricep Dips","Hammer Curls","Push-ups","Tricep Kickbacks","Diamond Push-ups","Chin-ups","Overhead Tricep Extension"],
      flexibility: ["Forward Fold","Butterfly Stretch","Cat-Cow Pose","Child’s Pose","Seated Twist","Cobra Stretch","Shoulder Rolls","Hamstring Stretch"],
      fullbody: ["Burpees","Jumping Jacks","Plank to Push-up","Mountain Climbers","Kettlebell Swing","Squat to Press","Bear Crawl","Skipping Rope"]
    };

    let userPlan = JSON.parse(localStorage.getItem('nutri_userPlan') || '[]');

    const workoutListEl = document.getElementById('workout-list');
    const planEl = document.getElementById('user-plan');
    const showBtn = document.getElementById('showBtn');
    const workoutTypeSel = document.getElementById('workoutType');
    const savePlanBtn = document.getElementById('savePlan');
    const exportBtn = document.getElementById('exportPlan');
    const clearSavedBtn = document.getElementById('clearSaved');
    const exportArea = document.getElementById('exportArea');

    // Load user session
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      alert("Please sign in first!");
      window.location.href = "signin.html";
    }

    // Show workouts based on selected type
    showBtn.addEventListener('click', () => {
      const type = workoutTypeSel.value;
      renderWorkoutOptions(type);
    });

    function renderWorkoutOptions(type) {
      if (!type || !workoutData[type]) {
        workoutListEl.innerHTML = `<p class="muted">Please select a workout type.</p>`;
        return;
      }

      const exercises = workoutData[type];
      const html = exercises.map(ex => `
        <div class="workout-card" data-ex="${escapeHtml(ex)}">
          <div class="wc-left">
            <p class="ex-name">${escapeHtml(ex)}</p>
            <small class="ex-type">${escapeHtml(type)}</small>
          </div>
          <div class="wc-right">
            <button class="add-btn" data-ex="${escapeHtml(ex)}"> + Add</button>
          </div>
        </div>
      `).join('');

      workoutListEl.innerHTML = `<div class="workout-cards">${html}</div>`;
      workoutListEl.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', () => addToPlan(btn.dataset.ex, type));
      });
    }

    // Add exercises to plan
    function addToPlan(name, type) {
      if (userPlan.some(item => item.name === name)) {
        flashMessage(`${name} already in plan`);
        return;
      }

      let sets = prompt("Enter sets (leave blank for N/A):", "3");
      if (sets === null) return;
      let reps = prompt("Enter reps per set (leave blank if not applicable):", "10");
      if (reps === null) return;
      let duration = prompt("Enter duration (e.g., 30s / 5min) or leave blank:", "");
      if (duration === null) return;

      const item = { name, type, sets: sets.trim() || null, reps: reps.trim() || null, duration: duration.trim() || null };
      userPlan.push(item);
      updatePlan();
      savePlanToStorage();
      flashMessage(`${name} added`);
    }

    function removeFromPlan(index) {
      userPlan.splice(index, 1);
      updatePlan();
      savePlanToStorage();
    }

    function updatePlan() {
      if (!userPlan.length) {
        planEl.innerHTML = `<p class="muted">No workouts added yet.</p>`;
        return;
      }

      const html = `
        <ul class="plan-list">
          ${userPlan.map((it, i) => `
            <li>
              <div class="plan-left">
                <strong>${escapeHtml(it.name)}</strong>
                <div class="meta">
                  ${it.sets ? `<span>Sets: ${escapeHtml(it.sets)}</span>` : ''}
                  ${it.reps ? `<span>Reps: ${escapeHtml(it.reps)}</span>` : ''}
                  ${it.duration ? `<span>Duration: ${escapeHtml(it.duration)}</span>` : ''}
                </div>
              </div>
              <div class="plan-right">
                <button class="remove-small" data-index="${i}">❌</button>
              </div>
            </li>
          `).join('')}
        </ul>`;
      planEl.innerHTML = html;

      planEl.querySelectorAll('.remove-small').forEach(btn => {
        btn.addEventListener('click', () => removeFromPlan(Number(btn.dataset.index)));
      });
    }

    function savePlanToStorage() {
      localStorage.setItem('nutri_userPlan', JSON.stringify(userPlan));
    }

    function loadPlanFromStorage() {
      userPlan = JSON.parse(localStorage.getItem('nutri_userPlan') || '[]') || [];
      updatePlan();
    }

    clearSavedBtn.addEventListener('click', () => {
      if (!confirm('Clear saved plan from local device?')) return;
      userPlan = [];
      savePlanToStorage();
      updatePlan();
      flashMessage('Saved plan cleared');
    });

    exportBtn.addEventListener('click', () => {
      if (!userPlan.length) {
        flashMessage('Plan is empty');
        return;
      }
      exportArea.hidden = false;
      exportArea.textContent = JSON.stringify(userPlan, null, 2);
      exportArea.scrollIntoView({ behavior: 'smooth' });
    });

    function flashMessage(msg) {
      const el = document.createElement('div');
      el.className = 'flash';
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.classList.add('show'), 10);
      setTimeout(() => el.classList.remove('show'), 2100);
      setTimeout(() => el.remove(), 2400);
    }

    function escapeHtml(s = '') {
      return (s + '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }

    // Load any existing plan
    loadPlanFromStorage();

    // Save workout plan to Supabase
    savePlanBtn.addEventListener('click', async () => {
      const planName = prompt("Enter a name for your workout plan:", "My Workout Plan");
      if (!planName) return alert("Please enter a plan name.");

      const plan = JSON.parse(localStorage.getItem('nutri_userPlan') || '[]');
      if (plan.length === 0) {
        alert("Please add exercises to your plan first!");
        return;
      }

      const { data, error } = await supabase
        .from('workouts')
        .insert([{
          user_id: user.id,
          plan_name: planName,
          exercises: JSON.stringify(plan),
          created_at: new Date().toISOString()
        }]);

      if (error) {
        console.error('Error saving workout:', error);
        alert('Failed to save your workout plan.');
      } else {
        alert('Workout plan saved successfully!');
        localStorage.removeItem('nutri_userPlan');
        window.location.href = 'Dashboard.html';
      }
    });
  </script>
</body>
</html>
