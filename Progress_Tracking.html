<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workout Progress - NutriHealth</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Auth Check Script -->
  <script src="auth-check.js"></script>
  <style>
    .progress-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .day-card {
      background: #fff;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .day-card.completed {
      border-color: #4caf50;
      background: #f1f8f4;
    }
    .day-card.partial {
      border-color: #ff9800;
      background: #fff8e1;
    }
    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .day-date {
      font-weight: bold;
      font-size: 16px;
    }
    .completion-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    .badge-completed {
      background: #4caf50;
      color: white;
    }
    .badge-partial {
      background: #ff9800;
      color: white;
    }
    .badge-none {
      background: #9e9e9e;
      color: white;
    }
    .exercise-list {
      list-style: none;
      padding: 0;
      margin: 10px 0 0 0;
    }
    .exercise-item {
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 4px;
      font-size: 14px;
    }
    .exercise-item.done {
      background: #c8e6c9;
      text-decoration: line-through;
    }
    .exercise-item.pending {
      background: #ffecb3;
    }
    .stats-summary {
      background: #e3f2fd;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .stats-row {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
    }
    .stat-box {
      text-align: center;
    }
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #1976d2;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div id="navbar-placeholder"></div>

  <div class="dashboard-container">
    <h1>Workout Progress & History ðŸ’ª</h1>
    <p>Track your daily workout completion and progress over time.</p>

    <!-- Stats Summary -->
    <div class="stats-summary">
      <h2>Your Stats</h2>
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-number" id="totalDays">0</div>
          <div class="stat-label">Total Days</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="completedDays">0</div>
          <div class="stat-label">Fully Completed</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="currentStreak">0</div>
          <div class="stat-label">Current Streak</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="completionRate">0%</div>
          <div class="stat-label">Completion Rate</div>
        </div>
      </div>
    </div>

    <!-- Calendar Section -->
    <div class="calendar-section">
      <h2>Daily Workout History</h2>
      <div id="progress-grid" class="progress-grid">
        <p class="muted">Loading workout history...</p>
      </div>
    </div>

    <!-- Progress Chart -->
    <div class="chart-section" style="margin-top: 30px;">
      <h2>Weekly Completion Trend</h2>
      <canvas id="progressChart"></canvas>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      alert("Please sign in first!");
      window.location.href = "signin.html";
    }

    const progressGridDiv = document.getElementById('progress-grid');
    const progressChartEl = document.getElementById('progressChart');

    let chart;

    // Load workout history on page load
    window.addEventListener('load', () => {
      loadWorkoutHistory();
    });

    function loadWorkoutHistory() {
      const dailyWorkouts = JSON.parse(localStorage.getItem('dailyWorkouts') || '{}');
      const dates = Object.keys(dailyWorkouts).sort().reverse(); // Most recent first

      if (dates.length === 0) {
        progressGridDiv.innerHTML = `
          <p style="color: #666;">No workout history yet. Create your first workout plan!</p>
          <a href="Workout_Generator.html" class="dashboard-link">Create Workout</a>
        `;
        return;
      }

      // Calculate stats
      calculateStats(dailyWorkouts, dates);

      // Display workout cards
      let html = '';
      dates.forEach(date => {
        const workout = dailyWorkouts[date];
        const exercises = workout.exercises || [];
        const totalExercises = exercises.length;
        const completedExercises = exercises.filter(ex => ex.completed).length;
        const completionPercent = totalExercises > 0 ? Math.round((completedExercises / totalExercises) * 100) : 0;

        let status = 'none';
        let badgeClass = 'badge-none';
        let cardClass = '';
        
        if (completionPercent === 100) {
          status = 'completed';
          badgeClass = 'badge-completed';
          cardClass = 'completed';
        } else if (completionPercent > 0) {
          status = 'partial';
          badgeClass = 'badge-partial';
          cardClass = 'partial';
        }

        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('en-US', { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric' 
        });

        html += `
          <div class="day-card ${cardClass}">
            <div class="day-header">
              <div class="day-date">${formattedDate}</div>
              <div class="completion-badge ${badgeClass}">${completionPercent}%</div>
            </div>
            <p style="margin: 5px 0; font-size: 13px; color: #666;">
              ${completedExercises} of ${totalExercises} exercises completed
            </p>
            <ul class="exercise-list">
        `;

        exercises.forEach(exercise => {
          const metaInfo = [];
          if (exercise.sets) metaInfo.push(`${exercise.sets} sets`);
          if (exercise.reps) metaInfo.push(`${exercise.reps} reps`);
          const metaStr = metaInfo.length > 0 ? ' - ' + metaInfo.join(' Ã— ') : '';
          
          html += `
            <li class="exercise-item ${exercise.completed ? 'done' : 'pending'}">
              ${exercise.completed ? 'âœ“' : 'â€¢'} ${exercise.name}${metaStr}
            </li>
          `;
        });

        html += `
            </ul>
          </div>
        `;
      });

      progressGridDiv.innerHTML = html;

      // Render chart
      renderProgressChart(dailyWorkouts, dates);
    }

    function calculateStats(dailyWorkouts, dates) {
      const totalDays = dates.length;
      let completedDays = 0;
      let totalExercises = 0;
      let completedExercises = 0;

      dates.forEach(date => {
        const workout = dailyWorkouts[date];
        const exercises = workout.exercises || [];
        const total = exercises.length;
        const completed = exercises.filter(ex => ex.completed).length;
        
        totalExercises += total;
        completedExercises += completed;
        
        if (total > 0 && completed === total) {
          completedDays++;
        }
      });

      // Calculate current streak (consecutive days with 100% completion)
      let currentStreak = 0;
      const today = new Date().toISOString().split('T')[0];
      const sortedDates = dates.sort().reverse();
      
      for (const date of sortedDates) {
        if (date > today) continue; // Skip future dates
        
        const workout = dailyWorkouts[date];
        const exercises = workout.exercises || [];
        const total = exercises.length;
        const completed = exercises.filter(ex => ex.completed).length;
        
        if (total > 0 && completed === total) {
          currentStreak++;
        } else {
          break;
        }
      }

      const completionRate = totalExercises > 0 
        ? Math.round((completedExercises / totalExercises) * 100) 
        : 0;

      // Update stats display
      document.getElementById('totalDays').textContent = totalDays;
      document.getElementById('completedDays').textContent = completedDays;
      document.getElementById('currentStreak').textContent = currentStreak;
      document.getElementById('completionRate').textContent = completionRate + '%';
    }

    function renderProgressChart(dailyWorkouts, dates) {
      // Get last 14 days
      const last14Days = [];
      for (let i = 13; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        last14Days.push(dateStr);
      }

      const labels = last14Days.map(date => {
        const d = new Date(date);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });

      const data = last14Days.map(date => {
        if (!dailyWorkouts[date]) return 0;
        const exercises = dailyWorkouts[date].exercises || [];
        const total = exercises.length;
        const completed = exercises.filter(ex => ex.completed).length;
        return total > 0 ? Math.round((completed / total) * 100) : 0;
      });

      if (chart) chart.destroy();
      chart = new Chart(progressChartEl, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Completion Rate (%)',
            data,
            backgroundColor: 'rgba(33, 150, 243, 0.2)',
            borderColor: '#2196f3',
            borderWidth: 2,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          }
        }
      });
    }
  </script>

  <script src="script.js"></script>
</body>
</html>
