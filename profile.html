<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Profile - NutriHealth</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="profile-container">
    <h1>My Profile</h1>

    <div class="profile-card">
      <form id="profileForm" onsubmit="updateProfile(event)">
        <label>Username</label>
        <input type="text" id="username" disabled>

        <label>Email</label>
        <input type="email" id="email" disabled>

        <label>Age</label>
        <input type="number" id="age" placeholder="Enter your age">

        <label>Gender</label>
        <select id="gender">
          <option value="">Select</option>
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>

        <label>Height (cm)</label>
        <input type="number" id="height" placeholder="Enter your height">

        <label>Weight (kg)</label>
        <input type="number" id="weight" placeholder="Enter your weight">

        <label>Activity Level</label>
        <select id="activity">
          <option value="">Select Activity Level</option>
          <option>Sedentary (Little exercise)</option>
          <option>Lightly Active</option>
          <option>Moderately Active</option>
          <option>Very Active</option>
        </select>

        <button type="submit" id="saveBtn">Save Profile</button>
        <button type="button" class="logout-btn" onclick="logoutUser()">Log Out</button>
      </form>
    </div>
  </div>

  <script type="module" src="script.js"></script>
  
  <script type="module">
    import { supabase } from './supabaseClient.js';

    let currentUser; // Store the user data

    // --- 1. Runs when the page loads ---
    window.onload = async () => {
      // Check for a Supabase user session
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        alert("Please sign in to view your profile.");
        window.location.href = "signin.html"; // Redirect to sign-in page
        return;
      }
      
      currentUser = user; // Save the user

      // Set the disabled fields
      // Use the username from Supabase metadata (if it exists)
      document.getElementById('username').value = user.user_metadata?.username || 'N/A';
      document.getElementById('email').value = user.email;

      // Now, go fetch the profile data from our new table
      loadProfileData();
    };

    // --- 2. Fetches data from the 'profiles' table ---
    async function loadProfileData() {
      if (!currentUser) return;

      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id) // Match the user's ID
        .single(); // We only expect one row

      if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
        console.error("Error loading profile:", error);
        return;
      }

      if (data) {
        // We found a profile! Let's fill the form.
        document.getElementById('age').value = data.age || '';
        document.getElementById('gender').value = data.gender || '';
        document.getElementById('height').value = data.height || '';
        document.getElementById('weight').value = data.weight || '';
        document.getElementById('activity').value = data.activity || '';
      }
    }

    // --- 3. Saves data to the 'profiles' table ---
    async function updateProfile(event) {
      event.preventDefault(); // Stop the form from submitting
      if (!currentUser) return;

      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      // Collect data from the form
      const profileData = {
        id: currentUser.id, // Match the user's ID
        age: document.getElementById('age').value || null,
        gender: document.getElementById('gender').value || null,
        height: document.getElementById('height').value || null,
        weight: document.getElementById('weight').value || null,
        activity: document.getElementById('activity').value || null,
        username: currentUser.user_metadata?.username, // Keep username in sync
      };

      // Use 'upsert' - it will CREATE or UPDATE the profile as needed.
      const { error } = await supabase
        .from('profiles')
        .upsert(profileData, { onConflict: ['id'] }); // Specify the conflict column

      if (error) {
        alert("Error updating profile: " + error.message);
      } else {
        alert("Profile updated successfully!");
      }
      
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Profile';
    }

    // --- 4. Logs the user out using Supabase ---
    async function logoutUser() {
      if (confirm("Are you sure you want to log out?")) {
        const { error } = await supabase.auth.signOut();
        if (error) {
          alert("Error logging out: " + error.message);
        } else {
          window.location.href = "home.html"; // Redirect to home
        }
      }
    }

    // --- 5. Make functions available to the HTML (onclick, onsubmit) ---
    window.updateProfile = updateProfile;
    window.logoutUser = logoutUser;
    
  </script>
</body>
</html>