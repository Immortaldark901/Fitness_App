<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Food Tracker - Nutri Health</title>
  <link rel="stylesheet" href="style.css">
  
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="dashboard-container">
    <h1>Your Daily Food Tracker üç±</h1>

    <div class="calorie-section">
      <h2>Set Daily Calorie Goal</h2>
      <label for="calorie-goal" class="visually-hidden">Calorie Goal (kcal)</label>
      <input type="number" id="calorie-goal" placeholder="Enter total calorie goal (kcal)">
      <button onclick="setGoal()">Save Goal</button>
    </div>

    <div class="food-section">
      <h2>Add Food</h2>
      <label for="food-select" class="visually-hidden">Select Indian Food</label>
      <select id="food-select" onchange="autoFillNutrition()">
        <option value="">-- Select Food --</option>
      </select>

      <div class="nutrition-inputs">
        <label for="food-calories">Calories (kcal)</label>
        <input type="number" id="food-calories" placeholder="Calories (kcal)">
        
        <label for="food-carbs">Carbs (g)</label>
        <input type="number" id="food-carbs" placeholder="Carbs (g)">
        
        <label for="food-proteins">Protein (g)</label>
        <input type="number" id="food-proteins" placeholder="Protein (g)">
        
        <label for="food-fats">Fat (g)</label>
        <input type="number" id="food-fats" placeholder="Fat (g)">
      </div>

      <div class="button-row">
        <button onclick="addFood()">Add to Today‚Äôs Intake</button>
        <button class="reset-btn" onclick="resetData()">Reset Day</button>
      </div>
    </div>

    <div class="summary">
      <h2>Today's Summary</h2>
      <p><b>Total Goal:</b> <span id="goal-display">0</span> kcal</p>
      <p><b>Consumed:</b> <span id="consumed-display">0</span> kcal</p>
      <p><b>Status:</b> <span id="remaining-display">0</span></p>
    </div>

    <div class="chart-section">
      <h2>Nutrient & Calorie Breakdown</h2>
      <div class="chart-wrapper">
        <canvas id="nutrientChart"></canvas>
      </div>
    </div>
  </div>

  <script type="module" src="script.js"></script>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    // ----------------------------- Indian Food Data -----------------------------
    // --- START OF EXPANDED LIST ---
    // I have added many new items to this list for you.
    const indianFoods = {
      alooGobi: { calories: 150, carbs: 20, proteins: 4, fats: 7 },
      biryani: { calories: 400, carbs: 50, proteins: 15, fats: 18 },
      butterChicken: { calories: 450, carbs: 15, proteins: 30, fats: 30 },
      choleBhature: { calories: 450, carbs: 60, proteins: 12, fats: 20 },
      chickenCurry: { calories: 300, carbs: 8, proteins: 25, fats: 16 },
      dalTadka: { calories: 180, carbs: 30, proteins: 9, fats: 6 },
      dhokla: { calories: 160, carbs: 25, proteins: 6, fats: 4 },
      dosa: { calories: 220, carbs: 35, proteins: 5, fats: 8 },
      gulabJamun: { calories: 150, carbs: 20, proteins: 2, fats: 7 },
      idli: { calories: 120, carbs: 25, proteins: 3, fats: 1 },
      jalebi: { calories: 100, carbs: 22, proteins: 1, fats: 0.5 },
      masalaDosa: { calories: 350, carbs: 50, proteins: 6, fats: 14 },
      naan: { calories: 260, carbs: 45, proteins: 8, fats: 5 },
      palakPaneer: { calories: 300, carbs: 10, proteins: 15, fats: 25 },
      paneerCurry: { calories: 250, carbs: 12, proteins: 14, fats: 18 },
      poha: { calories: 180, carbs: 30, proteins: 4, fats: 6 },
      rajma: { calories: 350, carbs: 55, proteins: 15, fats: 8 },
      rice: { calories: 200, carbs: 45, proteins: 4, fats: 1 },
      roti: { calories: 120, carbs: 20, proteins: 3, fats: 2 },
      samosa: { calories: 150, carbs: 20, proteins: 3, fats: 7 },
      tandooriChicken: { calories: 250, carbs: 5, proteins: 28, fats: 12 },
      upma: { calories: 200, carbs: 35, proteins: 5, fats: 5 },
      vadaPav: { calories: 300, carbs: 40, proteins: 7, fats: 12 }
    };
    // --- END OF EXPANDED LIST ---

    // --- Global variables for this page ---
    let goal = 0;
    let consumed = 0;
    let nutrients = { carbs: 0, proteins: 0, fats: 0 };
    let chart;
    let currentUser; // Will store the logged-in user
    let today; // Will store today's date string 'YYYY-MM-DD'

    // ----------------------------- Initialize Page on Load -----------------------------
    window.onload = async () => {
      // First, get the logged-in user
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        alert("You must be logged in to track your food.");
        window.location.href = 'signin.html';
        return;
      }
      currentUser = user;
      today = new Date().toISOString().split('T')[0]; // Get 'YYYY-MM-DD'

      // --- 1. Populate Food Dropdown (Your existing logic) ---
      // This code automatically finds the new items in 'indianFoods'
      const select = document.getElementById("food-select");
      const sortedFoods = Object.keys(indianFoods).sort((a, b) =>
        a.localeCompare(b)
      );
      sortedFoods.forEach(foodKey => {
        const option = document.createElement("option");
        // This line makes the name look nice, e.g., 'butterChicken' -> 'Butter Chicken'
        const name = foodKey.charAt(0).toUpperCase() + foodKey.slice(1).replace(/([A-Z])/g, ' $1');
        option.value = foodKey;
        option.textContent = name;
        select.appendChild(option);
      });

      // --- 2. Load Today's Data from Supabase ---
      await loadDataFromSupabase();
    };
    
    // --- Load data from Supabase ---
    async function loadDataFromSupabase() {
      const { data, error } = await supabase
        .from('daily_nutrition')
        .select('*')
        .eq('user_id', currentUser.id)
        .eq('date', today)
        .single(); // Get just one row

      if (data) {
        // Found data for today, load it
        goal = data.calorie_goal;
        consumed = data.consumed_calories;
        nutrients.carbs = data.consumed_carbs;
        nutrients.proteins = data.consumed_protein;
        nutrients.fats = data.consumed_fat;
      } else if (error && error.code !== 'PGRST116') {
        // PGRST116 means 'no rows found', which is fine.
        console.error("Error loading data:", error);
      }
      // If no data, all variables just stay at 0
      
      // Update the UI with loaded data
      document.getElementById('calorie-goal').value = goal || '';
      updateSummary();
      updateChart();
    }

    // --- Save data to Supabase ---
    async function saveDataToSupabase() {
      if (!currentUser) return; // Not logged in

      const row = {
        user_id: currentUser.id,
        date: today,
        calorie_goal: goal,
        consumed_calories: consumed,
        consumed_carbs: nutrients.carbs,
        consumed_protein: nutrients.proteins,
        consumed_fat: nutrients.fats
      };

      // 'upsert' will INSERT a new row if one doesn't exist for today,
      // or UPDATE it if it does. This is perfect for us.
      const { error } = await supabase
        .from('daily_nutrition')
        .upsert(row, { onConflict: ['user_id', 'date'] }); // Unique key
        
      if (error) {
        console.error("Failed to save data:", error);
      }
    }

    // ----------------------------- UI Functions (Now with saving) -----------------------------
    async function setGoal() {
      goal = parseInt(document.getElementById('calorie-goal').value) || 0;
      updateSummary();
      updateChart();
      await saveDataToSupabase(); // Save changes to DB
      alert("Goal updated!");
    }

    // This function (your "auto add") doesn't need any changes.
    // It will work with all the new foods.
    function autoFillNutrition() {
      const selected = document.getElementById('food-select').value;
      if (!selected) {
        // Clear fields if user selects "-- Select Food --"
        document.getElementById('food-calories').value = '';
        document.getElementById('food-carbs').value = '';
        document.getElementById('food-proteins').value = '';
        document.getElementById('food-fats').value = '';
        return;
      }
      const food = indianFoods[selected];
      document.getElementById('food-calories').value = food.calories;
      document.getElementById('food-carbs').value = food.carbs;
      document.getElementById('food-proteins').value = food.proteins;
      document.getElementById('food-fats').value = food.fats;
    }

    async function addFood() {
      const calories = parseInt(document.getElementById('food-calories').value);
      const carbs = parseInt(document.getElementById('food-carbs').value);
      const protein = parseInt(document.getElementById('food-proteins').value);
      const fat = parseInt(document.getElementById('food-fats').value);
      if (!calories) return alert("Please select a food or enter calories!");

      consumed += calories;
      nutrients.carbs += carbs || 0;
      nutrients.proteins += protein || 0;
      nutrients.fats += fat || 0;

      updateSummary();
      updateChart();
      await saveDataToSupabase(); // Save changes to DB

      // Reset input fields
      document.getElementById('food-select').value = "";
      document.querySelectorAll(".nutrition-inputs input").forEach(i => i.value = "");
    }
    
    async function resetData() {
      if (!confirm("Are you sure you want to reset all data for today?")) return;

      goal = parseInt(document.getElementById('calorie-goal').value) || 0; // Keep the goal
      consumed = 0;
      nutrients = { carbs: 0, proteins: 0, fats: 0 };

      updateSummary();
      updateChart();
      await saveDataToSupabase(); // Save the reset data (all zeros) to DB
    }

    // ----------------------------- UI Update Functions (No change) -----------------------------
    function updateSummary() {
      const remainingElem = document.getElementById('remaining-display');
      document.getElementById('goal-display').textContent = goal;
      document.getElementById('consumed-display').textContent = consumed;

      const remaining = goal - consumed;
      if (goal === 0) {
        remainingElem.textContent = "Set a goal to start";
        remainingElem.style.color = "#666";
      } else if (remaining > 0) {
        remainingElem.textContent = `${remaining} kcal remaining`;
        remainingElem.style.color = "#008000"; // green
      } else if (remaining === 0) {
        remainingElem.textContent = "Goal reached üéØ";
        remainingElem.style.color = "#0066cc";
      } else {
        remainingElem.textContent = `Exceeded by ${Math.abs(remaining)} kcal `;
        remainingElem.style.color = "#ff0000"; // red
      }
    }

    function updateChart() {
      const ctx = document.getElementById('nutrientChart');
      if (!ctx) return;
      
      const remaining = Math.max(goal - consumed, 0);
      const exceeded = consumed > goal ? consumed - goal : 0;

      // Convert grams to calories for the chart (approx)
      // 1g Carb = 4 cal, 1g Protein = 4 cal, 1g Fat = 9 cal
      const carbCals = nutrients.carbs * 4;
      const proteinCals = nutrients.proteins * 4;
      const fatCals = nutrients.fats * 9;

      const dataValues = [
        carbCals,
        proteinCals,
        fatCals,
        remaining,
      ];
      
      const labels = [
        `Carbs: ${carbCals} kcal (${nutrients.carbs}g)`,
        `Proteins: ${proteinCals} kcal (${nutrients.proteins}g)`,
        `Fats: ${fatCals} kcal (${nutrients.fats}g)`,
        `Remaining: ${remaining} kcal`,
      ];
      
      const colors = ['#FFB347', '#1E90FF', '#FF4C4C', '#2E2E2E'];

      if (exceeded > 0) {
        dataValues.push(exceeded);
        labels.push(`Over Limit: ${exceeded} kcal`);
        colors.push('#B22222'); // dark red for over limit
      }

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: dataValues,
            backgroundColor: colors,
            borderColor: '#121212',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#EAEAEA',
                font: { size: 14 }
              }
            }
          }
        }
      });

      ctx.parentElement.style.backgroundColor = "#121212";
      ctx.parentElement.style.borderRadius = "12px";
      ctx.parentElement.style.padding = "15px";
    }

    // --- Make functions available to HTML onclick ---
    window.setGoal = setGoal;
    window.autoFillNutrition = autoFillNutrition;
    window.addFood = addFood;
    window.resetData = resetData;

  </script>
</body>
</html>